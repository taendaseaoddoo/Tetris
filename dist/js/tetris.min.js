/*!
 * tetris 1.0.0
 * a Russian tile-matching puzzle video game
 * https://git.oschina.net/dewlyer/Tetris.git
 *
 * Copyright (c) 2016 dewlyer liluak@yeah.net
 *
 * Released under the MIT license
 */
 !function(t,e,o){"use strict";var i={options:{theme:null,blockWidth:1},_canvas:null,_ctx:null,_$game:null,_$canvas:null,_$gameholder:null,_$start:null,_$score:null,_$scoreText:null,_theme:{},theme:function(e){return"undefined"==typeof e?this.options.theme||this._theme:("string"==typeof e?(this.options.theme=e,this._theme=t.extend(!0,{},tetrisThemes[e])):(this.options.theme=null,this._theme=e),"undefined"!=typeof this._theme&&null!==this._theme||(this._theme=t.extend(!0,{},tetrisThemes.retro),this.options.theme="retro"),void((isNaN(parseInt(this._theme.strokeWidth))||"number"!=typeof parseInt(this._theme.strokeWidth))&&(this._theme.strokeWidth=2)))},_shapes:{line:[[0,-1,0,-2,0,-3,0,-4],[2,-2,1,-2,0,-2,-1,-2],[0,-4,0,-3,0,-2,0,-1],[-1,-2,0,-2,1,-2,2,-2]],square:[[0,0,1,0,0,-1,1,-1],[1,0,1,-1,0,0,0,-1],[1,-1,0,-1,1,0,0,0],[0,-1,0,0,1,-1,1,0]],arrow:[[0,-1,1,-1,2,-1,1,-2],[1,0,1,-1,1,-2,0,-1],[2,-1,1,-1,0,-1,1,0],[1,-2,1,-1,1,0,2,-1]],rightHook:[[2,0,1,0,1,-1,1,-2],[2,-2,2,-1,1,-1,0,-1],[0,-2,1,-2,1,-1,1,0],[0,0,0,-1,1,-1,2,-1]],leftHook:[[0,0,1,0,1,-1,1,-2],[2,0,2,-1,1,-1,0,-1],[2,-2,1,-2,1,-1,1,0],[0,-2,0,-1,1,-1,2,-1]],rightZag:[[1,0,1,-1,0,-1,0,-2],[2,-1,1,-1,1,0,0,0],[0,-2,0,-1,1,-1,1,0],[0,0,1,0,1,-1,2,-1]],leftZag:[[0,0,0,-1,1,-1,1,-2],[2,-1,1,-1,1,-2,0,-2],[1,-2,1,-1,0,-1,0,0],[0,-2,1,-2,1,-1,2,-1]]},_shapeFactory:null,init:function(){var t=this;t.theme(t.options.theme),t._create(),t._setup()},updateSiezs:function(){this._PIXEL_WIDTH=this._canvas.width(),this._PIXEL_HEIGHT=this._canvas.height(),this._BLOCK_WIDTH=this.options.blockWidth,this._BLOCK_HEIGHT=Math.floor(this._canvas.height()/this._canvas.width()*this._BLOCK_WIDTH),this._block_size=Math.floor(this._PIXEL_WIDTH/this._BLOCK_WIDTH),this._border_width=2,this._PIXEL_WIDTH=this._block_size*this._BLOCK_WIDTH,this._PIXEL_HEIGHT=this._block_size*this._BLOCK_HEIGHT,this._$canvas.attr("width",this._PIXEL_WIDTH).attr("height",this._PIXEL_HEIGHT)},_create:function(){var t=this;t._createHolder(),t._createUI(),t._createControls()},_setup:function(){var t=this;t._setupShapeFactory(),t._setupFilled(),t._setupInfo(),t._setupBoard(),t.drawBlock()},_createHolder:function(){console.log("_createHolder");var e=this;this._$gameholder=t('<div class="tetris-game-holder"></div>'),this._$gameholder.css({position:"relative",width:"100%",height:"100%"}),t(o.body).prepend(this._$gameholder),e._$score=t('<div class="tetris-score-holder"></div>'),e._$gameholder.append(e._$score),e._$start=t('<div class="tetris-start-holder"></div>'),e._$gameholder.append(e._$start)},_createUI:function(){console.log("_createUI");var e=this;e._$canvas=t('<canvas class="tetris-canvas"></canvas>'),e._$canvas.css("background-color",this._theme.background),e._$gameholder.prepend(this._$canvas),e._canvas=this._$canvas.get(0),e._ctx=this._canvas.getContext("2d")},_createControls:function(){console.log("_createControls")},_setupShapeFactory:function(){function e(t,e,o,i){this.x=0,this.y=0,this.symmetrical=o,this.blockType=i,this.blockVariation=null,this.blocksLen=e[0].length,this.orientations=e,this.orientation=0,this.init()}var o=this;null===o._shapeFactory&&(e.prototype.init=function(){this.orientation=0,this.x=Math.floor(o._BLOCK_WIDTH/2)-1,this.y=-1},e.prototype.rotate=function(){var t=(this.orientation+("left"===direction?1:-1)+4)%4;o._checkCollisions(this.x,this.y,this.getBlocks(t))||(this.orientation=t,o._board.renderChanged=!0)},e.prototype.moveRight=function(){o._checkCollisions(this.x+1,this.y,this.getBlocks())||(this.x++,o._board.renderChanged=!0)},e.prototype.moveLeft=function(){o._checkCollisions(this.x-1,this.y,this.getBlocks())||(this.x--,o._board.renderChanged=!0)},e.prototype.drop=function(){o._checkCollisions(this.x,this.y+1,this.getBlocks())||(this.y++,o._board.dropCount=-1,o._board.animate(),o._board.renderChanged=!0)},e.prototype.getBlocks=function(){return this.orientations[void 0!==orientation?orientation:this.orientation]},e.prototype.getBounds=function(){for(var e=t.isArray(_blocks)?_blocks:this.getBlocks(_blocks),o=0,i=e.length,s=999,h=-999,n=999,a=-999;o<i;o+=2)e[o]<s&&(s=e[o]),e[o]>h&&(h=e[o]),e[o+1]<n&&(n=e[o+1]),e[o+1]>a&&(a=e[o+1]);return{left:s,right:h,top:n,bottom:a,width:h-s,height:a-n}},e.prototype.draw=function(){for(var t=this.getBlocks(_orientation),e=void 0===_x?this.x:_x,i=void 0===_y?this.y:_y,s=0,h=0;s<this.blocksLen;s+=2)o._board.drawBlock(e+t[s],i+t[s+1],this.blockType,this.blockVariation,h,this.orientation,!0),h++},this._shapeFactory={line:new e(o,o._shapes.line,(!1),"line"),square:new e(o,o._shapes.square,(!1),"square"),arrow:new e(o,o._shapes.arrow,(!1),"arrow"),leftHook:new e(o,o._shapes.leftHook,(!1),"leftHook"),rightHook:new e(o,o._shapes.rightHook,(!1),"rightHook"),leftZag:new e(o,o._shapes.leftZag,(!1),"leftZag"),rightZag:new e(o,o._shapes.rightZag,(!1),"rightZag")})},_setupFilled:function(){console.log("_setupFilled")},_setupInfo:function(){console.log("_setupInfo")},_setupBoard:function(){console.log("_setupBoard")},_drawBackground:function(){var t=this._theme.strokeWidth;Math.round(.23),Math.round(.3);this._ctx.globalAlpha=1,this._ctx.fillStyle=this._theme.backgroundGrid;for(var e=0;e<this._BLOCK_WIDTH;e++)for(var o=0;o<this._BLOCK_HEIGHT;o++){var i=e*this._block_size,s=o*this._block_size;this._ctx.fillRect(i+t,s+t,this._block_size-2*t,this._block_size-2*t)}this._ctx.globalAlpha=1},drawBlock:function(t,e,o,i,s,h,n){var a=this;t*=a._block_size,e*=a._block_size,n="boolean"==typeof n&&n;var r=(a._theme.strokeWidth,Math.round(.23*a._block_size),Math.round(.3*a._block_size),new Image("../images/block.png")),_={x:0,y:0,w:100,h:100};a._ctx.globalAlpha=1,a._ctx.save(),a._ctx.translate(t,e),a._ctx.translate(a._block_size/2,a._block_size/2),a._ctx.rotate(-Math.PI/2*h),a._ctx.drawImage(r,_.x,_.y,_.w,_.h,-a._block_size/2,-a._block_size/2,a._block_size,a._block_size),a._ctx.restore()},start:function(){this._doStart()},restart:function(){this._doStart()},_doStart:function(){}};t(function(){var t=Object.create(i);t.init()})}(jQuery,window,document);