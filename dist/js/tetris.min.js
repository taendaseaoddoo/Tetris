/*!
 * tetris 1.0.0
 * A Russian tile-matching puzzle video game
 * https://git.oschina.net/dewlyer/Tetris.git
 *
 * Copyright (c) 2017 dewlyer liluak@yeah.net
 *
 * Released under the MIT license
 */
 !function(t,e,o){"use strict";function i(t,e,o,i){this.x=0,this.y=0,this.game=t,this.symmetrical=o,this.blockType=i,this.blockVariation=null,this.blocksLen=e[0].length,this.orientations=e,this.orientation=0,this.init()}function n(t,e){this.options=t,this.element=e,this._canvas=null,this._ctx=null,this._$game=null,this._$canvas=null,this._$gameholder=null,this._$start=null,this._$score=null,this._$scoreText=null,this._theme={},this._board=null,this._info=null,this._filled=null,this._shapeFactory=null,this._shapes={line:[[0,-1,0,-2,0,-3,0,-4],[2,-2,1,-2,0,-2,-1,-2],[0,-4,0,-3,0,-2,0,-1],[-1,-2,0,-2,1,-2,2,-2]],square:[[0,0,1,0,0,-1,1,-1],[1,0,1,-1,0,0,0,-1],[1,-1,0,-1,1,0,0,0],[0,-1,0,0,1,-1,1,0]],arrow:[[0,-1,1,-1,2,-1,1,-2],[1,0,1,-1,1,-2,0,-1],[2,-1,1,-1,0,-1,1,0],[1,-2,1,-1,1,0,2,-1]],rightHook:[[2,0,1,0,1,-1,1,-2],[2,-2,2,-1,1,-1,0,-1],[0,-2,1,-2,1,-1,1,0],[0,0,0,-1,1,-1,2,-1]],leftHook:[[0,0,1,0,1,-1,1,-2],[2,0,2,-1,1,-1,0,-1],[2,-2,1,-2,1,-1,1,0],[0,-2,0,-1,1,-1,2,-1]],rightZag:[[1,0,1,-1,0,-1,0,-2],[2,-1,1,-1,1,0,0,0],[0,-2,0,-1,1,-1,1,0],[0,0,1,0,1,-1,2,-1]],leftZag:[[0,0,0,-1,1,-1,1,-2],[2,-1,1,-1,1,-2,0,-2],[1,-2,1,-1,0,-1,0,0],[0,-2,1,-2,1,-1,2,-1]]}}var r={audioEl:null,audioObj:null,currentId:-1,holder:"body",paths:"",playList:null,isRandom:!1,init:function(t){this.holder=t.holder||this.holder,this.isRandom=t.random||this.isRandom,this.paths=t.paths||this.paths,this.initPlayList(t.playlist),this.initAudio()},initPlayList:function(t){var e=typeof t;"undefined"===e?console.error("music list error!"):(this.playList=[],this.currentId=0,"string"===e?this.playList.push(t):this.playList=t)},initAudio:function(){this.audioEl=t("<audio>"),this.audioEl.attr("id","gameBgm").addClass("bgm-holder"),this.audioObj=this.audioEl[0],this.audioEl.appendTo(this.holder).hide(),this.bindEvent()},bindEvent:function(){var t=this;t.audioEl.on("ended",function(){t.playNext()})},randomId:function(){var t=this.playList.length;this.currentId=Math.floor(Math.random()*t)},stop:function(){this.audioObj.paused||this.audioObj.pause()},play:function(){this.isRandom&&this.randomId(),this.stop(),this.audioObj.src=this.paths+this.playList[this.currentId],this.audioObj.play()},playNext:function(){if(this.isRandom)this.randomId();else{var t=this.playList.length-1;this.currentId=this.currentId>=t?0:this.currentId+1}this.play()}};i.prototype={init:function(){this.orientation=0,this.x=Math.floor(this.game._BLOCK_WIDTH/2)-1,this.y=-1},rotate:function(t){var e=(this.orientation+("left"===t?1:-1)+4)%4;this.game._checkCollisions(this.x,this.y,this.getBlocks(e))||(this.orientation=e,this.game._board.renderChanged=!0)},moveRight:function(){this.game._checkCollisions(this.x+1,this.y,this.getBlocks())||(this.x++,this.game._board.renderChanged=!0)},moveLeft:function(){this.game._checkCollisions(this.x-1,this.y,this.getBlocks())||(this.x--,this.game._board.renderChanged=!0)},drop:function(){this.game._checkCollisions(this.x,this.y+1,this.getBlocks())||(this.y++,this.game._board.dropCount=-1,this.game._board.animate(),this.game._board.renderChanged=!0)},getBlocks:function(t){return this.orientations[void 0!==t?t:this.orientation]},draw:function(t,e,o){for(var i=this.getBlocks(o),n=void 0===t?this.x:t,r=void 0===e?this.y:e,s=0,a=0;s<this.blocksLen;s+=2)this.game._board.drawBlock(n+i[s],r+i[s+1],this.blockType,this.blockVariation,a,this.orientation,!0),a++},getBounds:function(e){for(var o=t.isArray(e)?e:this.getBlocks(e),i=0,n=o.length,r=999,s=-999,a=999,h=-999;i<n;i+=2)o[i]<r&&(r=o[i]),o[i]>s&&(s=o[i]),o[i+1]<a&&(a=o[i+1]),o[i+1]>h&&(h=o[i+1]);return{left:r,right:s,top:a,bottom:h,width:s-r,height:h-a}}},n.prototype={start:function(){this._doStart(),this.options.onStart.call(this.element)},restart:function(){this._doStart(),this.options.onRestart.call(this.element)},gameover:function(){this.showGameOverMessage(),this._board.gameover=!0,this.options.onGameOver.call(this.element,this._filled.score)},_doStart:function(){this._filled.clearAll(),this._filled._resetScore(),this._board.cur=this._board.nextShape(),this._board.started=!0,this._board.gameover=!1,this._board.dropDelay=5,this._board.render(!0),this._board.animate(),this._$start.fadeOut(150),this._$gameover.fadeOut(150),this._$score.fadeIn(150)},pause:function(){this._board.paused=!0},resume:function(){this._board.paused=!1},autoplay:function(t){"boolean"!=typeof t&&(t=!0),this.options.autoplay=t,t&&!this._board.started&&this._doStart(),this._setupControls(!t),this._setupTouchControls(!t)},controls:function(t){"boolean"!=typeof t&&(t=!0),this._setupControls(t)},touchControls:function(t){"boolean"!=typeof t&&(t=!0),this._setupTouchControls(t)},score:function(t){return"undefined"!=typeof t&&parseInt(t)>=0&&(this._filled.score=parseInt(t),this._$scoreText.text(this._filled_score)),this._filled.score},freesquares:function(){return this._filled.getFreeSpaces()},showStartMessage:function(){this._$start.show()},showGameOverMessage:function(){this._$gameover.show()},_checkCollisions:function(t,e,o,i){for(var n,r,s=0,a=o.length;s<a;s+=2){if(n=t+o[s],r=e+o[s+1],r>=this._BLOCK_HEIGHT||this._filled.check(n,r))return!0;if(!i&&n<0||n>=this._BLOCK_WIDTH)return!0}return!1},_drawBackground:function(){if("string"==typeof this._theme.background){if(this._theme.backgroundGrid instanceof Image){if(0===this._theme.backgroundGrid.width||0===this._theme.backgroundGrid.height)return;this._ctx.globalAlpha=1;for(var t=0;t<this._BLOCK_WIDTH;t++)for(var e=0;e<this._BLOCK_HEIGHT;e++){var o=t*this._block_size,i=e*this._block_size;this._ctx.drawImage(this._theme.backgroundGrid,0,0,this._theme.backgroundGrid.width,this._theme.backgroundGrid.height,o,i,this._block_size,this._block_size)}}else if("string"==typeof this._theme.backgroundGrid){var n=this._theme.strokeWidth;Math.round(.23*this._block_size),Math.round(.3*this._block_size);this._ctx.globalAlpha=1,this._ctx.fillStyle=this._theme.backgroundGrid;for(var t=0;t<this._BLOCK_WIDTH;t++)for(var e=0;e<this._BLOCK_HEIGHT;e++){var o=t*this._block_size,i=e*this._block_size;this._ctx.fillRect(o+n,i+n,this._block_size-2*n,this._block_size-2*n)}}this._ctx.globalAlpha=1}},_refreshBlockSizes:function(){this.options.autoBlockWidth&&(this.options.blockWidth=Math.ceil(this.element.width()/this.options.autoBlockSize))},updateSizes:function(){var t=this;t._PIXEL_WIDTH=t.element.innerWidth(),t._PIXEL_HEIGHT=t.element.innerHeight(),t._BLOCK_WIDTH=t.options.blockWidth,t._BLOCK_HEIGHT=Math.floor(t.element.innerHeight()/t.element.innerWidth()*t._BLOCK_WIDTH),t._block_size=Math.floor(t._PIXEL_WIDTH/t._BLOCK_WIDTH),t._border_width=2,t._PIXEL_WIDTH=t._block_size*t._BLOCK_WIDTH,t._PIXEL_HEIGHT=t._block_size*t._BLOCK_HEIGHT,t._$canvas.attr({width:t._PIXEL_WIDTH,height:t._PIXEL_HEIGHT})},_getNiceShapes:function(){function t(t,e,o,n,r,s,a){var h,l,c,d,_=e.length,u=0,f={};for(h=0;h<_;h+=2)u+=t[i._filled.asIndex(o+e[h],n+e[h+1])]||0;for(h=0;h<_;h+=2)l=e[h],c=e[h+1],(void 0===f[l]||f[l]<c)&&(f[l]=c);d=0;for(l in f)for(l=parseInt(l),c=f[l]+1,h=0;n+c<a;c++,h++)if(!i._filled.check(o+l,n+c)){d+=0==h?2:1;break}return u-=d}function e(){for(var t in n)n[t].x=0,n[t].y=-1}var o,i=this,n={};for(var o in this._shapeFactory)n[o]=this._shapeFactory[o]();var r=function(o,r,s,a,h,l){l||e();var c,d,_,u,f,p,g,b,m,k,y,v,x,w,I,C=new Array(s*a),T="evil"==h,B=999*(T?1:-1);for(c=0;c<s;c++)for(d=0;d<=a;d++)if(d==a||o.check(c,d)){for(_=d-4;_<d;_++)C[o.asIndex(c,_)]=_;break}var H=void 0===l?n:{cur:l};for(u in H){for(f=H[u],x=-999,p=0;p<(f.symmetrical?2:4);p++)for(g=f.getBlocks(p),b=f.getBounds(g),c=-b.left;c<s-b.width;c++)for(d=-1;d<a-b.bottom;d++)if(i._checkCollisions(c,d+1,g,!0)){m=t(C,g,c,d,o,s,a),m>x&&(x=m,w=p,I=c);break}(T&&x<B||!T&&x>B)&&(k=f,B=x,y=w,v=I)}return k.best_orientation=y,k.best_x=v,k};return r.no_preview=!0,r},_randomShapes:function(){var e=[];return t.each(this._shapeFactory,function(t,o){e.push(o)}),this._randChoice(e)},_randInt:function(t,e){return t+Math.floor(Math.random()*(1+e-t))},_randSign:function(){return 2*this._randInt(0,1)-1},_randChoice:function(t){return t[this._randInt(0,t.length-1)]},_preloadThemeAssets:function(){var e=this,o=new RegExp("^#[A-F0-9+]{3,6}","i"),i=(new RegExp("^data:image/(png|gif|jpg);base64,","i"),function(){e._board&&e._board.render(!0)}),n=function(t){var e=t;return o.test(e)?t=e:(t=new Image,t.src=e,t.onload=i),t},r=function(e){if(t.isArray(e)&&e.length>0)for(var o=0;o<e.length;o++)e[o]=n(e[o]);else"string"==typeof e&&(e=n(e));return e};if("undefined"!=typeof this._theme.complexBlocks)for(var s=Object.keys(this._theme.complexBlocks),a=0;a<s.length;a++)this._theme.complexBlocks[s[a]]=r(this._theme.complexBlocks[s[a]]);else if("undefined"!=typeof this._theme.blocks)for(var s=Object.keys(this._theme.blocks),a=0;a<s.length;a++)this._theme.blocks[s[a]]=r(this._theme.blocks[s[a]]);if("undefined"!=typeof this._theme.backgroundGrid&&"string"==typeof this._theme.backgroundGrid&&!o.test(this._theme.backgroundGrid)){var h=this._theme.backgroundGrid;this._theme.backgroundGrid=new Image,this._theme.backgroundGrid.src=h,this._theme.backgroundGrid.onload=i}},theme:function(){this._theme=this.options.theme,this._preloadThemeAssets(),null!==this._board&&this._board.render()},_createHolder:function(){var e=this;e._$gameholder=t("<div>"),e._$gameholder.addClass("tetris game-holder").css({position:"relative",width:"100%",height:"100%"}),e._$canvas=t("<canvas>"),e._$canvas.addClass("canvas").attr({width:"100%",height:"100%"}).prependTo(e._$gameholder),e.element.empty().append(e._$gameholder),e._canvas=e._$canvas.get(0),e._ctx=e._canvas.getContext("2d")},_createUI:function(){var e=this;e._$score=t('<div class="score-holder"><div class="score"><div class="score-msg">'+this.options.scoreText+'</div><div class="score-num">0</div></div></div>').hide(),e._$scoreText=e._$score.find(".score-num"),e._$gameholder.append(e._$score),e._$start=t('<div class="start-holder"><div class="start"><div class="start-msg">'+this.options.playText+'</div><a class="btn start-btn">'+this.options.playButtonText+"</a></div></div>").hide(),e._$gameholder.append(e._$start),e._$start.find(".start-btn").click(function(t){t.preventDefault(),e.start()}),e._$gameover=t('<div class="game-over-holder"><div class="game-over"><div class="game-over-msg">'+this.options.gameOverText+'</div><a class="btn game-over-btn">'+this.options.restartButtonText+"</a></div></div>").hide(),e._$gameover.find(".game-over-btn").click(function(t){t.preventDefault(),e.restart()}),e._$gameholder.append(e._$gameover)},_createControls:function(){var e=this;e._$touchLeft=t('<a class="touch touch-left" />').appendTo(e._$gameholder),e._$touchRight=t('<a class="touch touch-right" />').appendTo(e._$gameholder),e._$touchRotateRight=t('<a class="touch touch-rotate-right" />').appendTo(e._$gameholder),e._$touchRotateLeft=t('<a class="touch touch-rotate-left" />').appendTo(e._$gameholder),e._$touchDrop=t('<a class="touch touch-drop" />').appendTo(e._$gameholder)},_create:function(){var t=this;t._createHolder(),t._createUI(),t._createControls()},_setup:function(){var t=this;t._SetupShapeFactory(),t._SetupFilled(),t._SetupInfo(),t._SetupBoard()},_SetupShapeFactory:function(){var t=this;null===t._shapeFactory&&(t._shapeFactory={line:function(){return new i(t,t._shapes.line,(!1),"line")},square:function(){return new i(t,t._shapes.square,(!1),"square")},arrow:function(){return new i(t,t._shapes.arrow,(!1),"arrow")},leftHook:function(){return new i(t,t._shapes.leftHook,(!1),"leftHook")},rightHook:function(){return new i(t,t._shapes.rightHook,(!1),"rightHook")},leftZag:function(){return new i(t,t._shapes.leftZag,(!1),"leftZag")},rightZag:function(){return new i(t,t._shapes.rightZag,(!1),"rightZag")}})},_SetupFilled:function(){var t=this;null===this._filled&&(this._filled={data:new Array(t._BLOCK_WIDTH*t._BLOCK_HEIGHT),score:0,toClear:{},check:function(t,e){return this.data[this.asIndex(t,e)]},add:function(e,o,i,n,r,s){e>=0&&e<t._BLOCK_WIDTH&&o>=0&&o<t._BLOCK_HEIGHT&&(this.data[this.asIndex(e,o)]={blockType:i,blockVariation:n,blockIndex:r,blockOrientation:s})},getFreeSpaces:function(){for(var t=0,e=0;e<this.data.length;e++)t+=this.data[e]?1:0},asIndex:function(e,o){return e+o*t._BLOCK_WIDTH},asX:function(e){return e%t._BLOCK_WIDTH},asY:function(e){return Math.floor(e/t._BLOCK_WIDTH)},clearAll:function(){delete this.data,this.data=new Array(t._BLOCK_WIDTH*t._BLOCK_HEIGHT)},_popRow:function(e){for(var o=t._BLOCK_WIDTH*(e+1)-1;o>=0;o--)this.data[o]=o>=t._BLOCK_WIDTH?this.data[o-t._BLOCK_WIDTH]:void 0},checkForClears:function(){var e,o,i,n,r=t._board.lines,s=[];for(e=0,o=this.data.length;e<o;e++)n=this.asX(e),0==n&&(i=0),this.data[e]&&"undefined"!=typeof this.data[e]&&"string"==typeof this.data[e].blockType&&(i+=1),n==t._BLOCK_WIDTH-1&&i==t._BLOCK_WIDTH&&s.push(this.asY(e));for(e=0,o=s.length;e<o;e++)this._popRow(s[e]),t._board.lines++,t._board.lines%10==0&&t._board.dropDelay>1&&(t._board.dropDelay*=.9);var a=t._board.lines-r;this._updateScore(a)},_updateScore:function(e){if(!(e<=0)){var o=[0,400,1e3,3e3,12e3];e>=o.length&&(e=o.length-1),this.score+=o[e],t._$scoreText.text(this.score),t.options.onLine.call(t.element,e,o[e],this.score)}},_resetScore:function(){this.score=0,t._$scoreText.text(this.score)},draw:function(){for(var e,o=0,i=this.data.length;o<i;o++)if(void 0!==this.data[o]){e=this.asY(o);var n=this.data[o];t._board.drawBlock(this.asX(o),e,n.blockType,n.blockVariation,n.blockIndex,n.blockOrientation)}}})},_SetupInfo:function(){var t=this;this._info={mode:t.options.difficulty,modes:["normal","nice","evil"],modesY:170,autopilotY:null,init:function(){this.mode=t.options.difficulty},setMode:function(e){this.mode=e,t._board.nextShape(!0)}}},_SetupBoard:function(){var o=this,i=this._info;this._board={animateDelay:1e3/o.options.speed,animateTimeoutId:null,cur:null,lines:0,dropCount:0,dropDelay:5,holding:{left:null,right:null,drop:null},holdingThreshold:200,started:!1,gameover:!1,renderChanged:!0,init:function(){this.cur=this.nextShape(),o.options.showFieldOnStart&&(o._drawBackground(),o._board.createRandomBoard(),o._board.render()),this.showStartMessage()},showStartMessage:function(){o._$start.show()},showGameOverMessage:function(){o._$gameover.show()},nextShape:function(e){var n,r,s,a=this.next;if(n="nice"==i.mode||"evil"==i.mode?o._niceShapes:o._randomShapes(),o.options.no_preview){if(this.next=null,e)return null;if(r=n(o._filled,o._checkCollisions,o._BLOCK_WIDTH,o._BLOCK_HEIGHT,i.mode),!r)throw new Error("No shape returned from shape function!",n);r.init(),s=r}else{if(r=n(o._filled,o._checkCollisions,o._BLOCK_WIDTH,o._BLOCK_HEIGHT,i.mode),!r)throw new Error("No shape returned from shape function!",n);if(r.init(),this.next=r,e)return null;s=a||this.nextShape()}return o.options.autoplay&&(o._niceShapes(o._filled,o._checkCollisions,o._BLOCK_WIDTH,o._BLOCK_HEIGHT,"normal",s),s.orientation=s.best_orientation,s.x=s.best_x),"undefined"!=typeof o._theme.complexBlocks?t.isArray(o._theme.complexBlocks[s.blockType])?s.blockVariation=o._randInt(0,o._theme.complexBlocks[s.blockType].length-1):s.blockVariation=null:"undefined"!=typeof o._theme.blocks&&(t.isArray(o._theme.blocks[s.blockType])?s.blockVariation=o._randInt(0,o._theme.blocks[s.blockType].length-1):s.blockVariation=null),s},animate:function(){var t=!1,i=!1,n=!1,r=Date.now();if(this.animateTimeoutId&&clearTimeout(this.animateTimeoutId),!this.paused&&!this.gameover&&(this.dropCount++,(this.dropCount>=this.dropDelay||o.options.autoplay||this.holding.drop&&r-this.holding.drop>=this.holdingThreshold)&&(t=!0,i=!0,this.dropCount=0),this.holding.left&&r-this.holding.left>=this.holdingThreshold&&(i=!0,this.cur.moveLeft()),this.holding.right&&r-this.holding.right>=this.holdingThreshold&&(i=!0,this.cur.moveRight()),t)){var s=this.cur,a=s.x,h=s.y,l=s.getBlocks();if(o._checkCollisions(a,h+1,l,!0)){t=!1;for(var c=0,d=0;d<s.blocksLen;d+=2)o._filled.add(a+l[d],h+l[d+1],s.blockType,s.blockVariation,c,s.orientation),h+l[d]<0&&(n=!0),c++;o._filled.checkForClears(),this.cur=this.nextShape(),this.renderChanged=!0,this.holding.left=null,this.holding.right=null,this.holding.drop=null,o.options.onPlaced.call(o.element)}}t&&(i=!0,this.cur.y++),(t||i)&&(this.renderChanged=!0),n?(this.gameover=!0,o.gameover(),o.options.autoplay&&o.options.autoplayRestart&&o.restart(),this.renderChanged=!0):(this.animateDelay=1e3/o.options.speed,this.animateTimeoutId=e.setTimeout(function(){o._board.animate()},this.animateDelay))},createRandomBoard:function(){var t,e,i,n,r,s=[];for(s=Object.keys(o._shapeFactory),t=0,e=o._BLOCK_WIDTH;t<e;t++)for(i=0,n=o._randChoice([o._randInt(0,8),o._randInt(5,9)]);i<n;i++)r&&o._randInt(0,3)||(r=o._randChoice(s)),o._filled.add(t,o._BLOCK_HEIGHT-i,r,o._randInt(0,3),null,o._randInt(0,3));o._board.render(!0)},render:function(t){(this.renderChanged||t)&&(this.renderChanged=!1,o._ctx.clearRect(0,0,o._PIXEL_WIDTH,o._PIXEL_HEIGHT),o._drawBackground(),o._filled.draw(),this.cur.draw())},drawBlock:function(t,e,i,n,r,s,a){t*=o._block_size,e*=o._block_size,a="boolean"==typeof a&&a;var h=o._theme.strokeWidth,l=Math.round(.23*o._block_size),c=Math.round(.3*o._block_size),d=this.getBlockColor(i,n,r,a);if(o._ctx.globalAlpha=1,d instanceof Image){if(o._ctx.globalAlpha=1,0===d.width||0===d.height)return;if("undefined"!=typeof o._theme.blocks&&null!==o._theme.blocks)o._ctx.drawImage(d,0,0,d.width,d.height,t,e,o._block_size,o._block_size);else if("undefined"!=typeof o._theme.complexBlocks&&null!==o._theme.complexBlocks){"undefined"!=typeof r&&null!==r||(r=0);var _=function(t,e,i){var n=o._shapes[e][0],r=Math.min(n[0],n[2],n[4],n[6]),s=Math.max(n[0],n[2],n[4],n[6]),a=Math.min(n[1],n[3],n[5],n[7]),h=Math.max(n[1],n[3],n[5],n[7]),l=s-r+1,c=h-a+1,d=t.width/l,_=t.height/c;return{x:d*(n[2*i]-r),y:_*Math.abs(a-n[2*i+1]),w:d,h:_}},u=_(d,i,r);o._ctx.save(),o._ctx.translate(t,e),o._ctx.translate(o._block_size/2,o._block_size/2),o._ctx.rotate(-Math.PI/2*s),o._ctx.drawImage(d,u.x,u.y,u.w,u.h,-o._block_size/2,-o._block_size/2,o._block_size,o._block_size),o._ctx.restore()}else o._ctx.fillStyle="#ff0000",o._ctx.fillRect(t,e,o._block_size,o._block_size)}else"string"==typeof d&&(o._ctx.fillStyle=d,o._ctx.fillRect(t,e,o._block_size,o._block_size),"string"==typeof o._theme.innerShadow&&(o._ctx.globalAlpha=1,o._ctx.strokeStyle=o._theme.innerShadow,o._ctx.lineWidth=1,o._ctx.strokeRect(t+1,e+1,o._block_size-2,o._block_size-2)),"string"==typeof o._theme.stroke&&(o._ctx.globalAlpha=1,o._ctx.fillStyle=o._theme.stroke,o._ctx.strokeStyle=o._theme.stroke,o._ctx.lineWidth=h,o._ctx.strokeRect(t,e,o._block_size,o._block_size)),"string"==typeof o._theme.innerStroke&&(o._ctx.fillStyle=o._theme.innerStroke,o._ctx.fillRect(t+l,e+l,o._block_size-2*l,h),o._ctx.fillRect(t+l,e+l+h,h,o._block_size-2*l-h)),"string"==typeof o._theme.innerSquare&&(o._ctx.fillStyle=o._theme.innerSquare,o._ctx.globalAlpha=.2,o._ctx.fillRect(t+c,e+c,o._block_size-2*c,o._block_size-2*c)));o._ctx.globalAlpha=1},getBlockColor:function(e,i,n,r){var s=function(e,o){return t.isArray(e)?null!==o&&"undefined"!=typeof e[o]?e[o]:e.length>0?e[0]:null:e};return"boolean"!=typeof r&&(r=!0),r?"string"==typeof o._theme.primary&&""!==o._theme.primary?o._theme.primary:"undefined"!=typeof o._theme.blocks&&null!==o._theme.blocks?s(o._theme.blocks[e],i):s(o._theme.complexBlocks[e],i):"string"==typeof o._theme.secondary&&""!==o._theme.secondary?o._theme.secondary:"undefined"!=typeof o._theme.blocks&&null!==o._theme.blocks?s(o._theme.blocks[e],i):s(o._theme.complexBlocks[e],i)}},o._niceShapes=o._getNiceShapes()},_setupControls:function(e){function i(t){var e={stopKeys:{37:1,38:1,39:1,40:1}},o=e.stopKeys[t.keyCode]||e.moreStopKeys&&e.moreStopKeys[t.keyCode];return o&&t.preventDefault(),o}function n(t){return"safekeypress."+t.keyCode}function r(e){var o=n(e);return t.data(this,o,(t.data(this,o)||0)-1),d.call(this,e)}function s(e){return t.data(this,n(e),0),_.call(this,e),i(e)}var a=this,h=function(t){return t?void(a._board.holding.left||(a._board.cur.moveLeft(),a._board.holding.left=Date.now(),a._board.holding.right=null)):void(a._board.holding.left=null)},l=function(t){return t?void(a._board.holding.right||(a._board.cur.moveRight(),a._board.holding.right=Date.now(),a._board.holding.left=null)):void(a._board.holding.right=null)},c=function(t){return t?void(a._board.holding.drop||(a._board.cur.drop(),a._board.holding.drop=Date.now())):void(a._board.holding.drop=null)},d=function(t){if(!a._board.cur)return!0;var e=!1;if(e=!0,a.options.asdwKeys)switch(t.keyCode){case 65:h(!0);break;case 68:l(!0);break;case 83:c(!0);break;case 87:a._board.cur.rotate("right")}switch(t.keyCode){case 37:h(!0);break;case 39:l(!0);break;case 40:c(!0);break;case 38:a._board.cur.rotate("right");break;case 88:a._board.cur.rotate("right");break;case 90:a._board.cur.rotate("left");break;default:e=!1}return e&&t.preventDefault(),!e},_=function(t){if(!a._board.cur)return!0;var e=!1;if(e=!0,a.options.asdwKeys)switch(t.keyCode){case 65:h(!1);break;case 68:l(!1);break;case 83:c(!1)}switch(t.keyCode){case 37:h(!1);break;case 39:l(!1);break;case 40:c(!1);break;default:e=!1}return e&&t.preventDefault(),!e};t(o).unbind("keydown.blockrain").unbind("keyup.blockrain"),a.options.autoplay||e&&t(o).bind("keydown.blockrain",r).bind("keyup.blockrain",s)},_setupTouchControls:function(t){var e=this,o=function(t){t.preventDefault(),e._board.cur.moveLeft(),e._board.holding.left=Date.now(),e._board.holding.right=null,e._board.holding.drop=null},i=function(t){t.preventDefault(),e._board.cur.moveRight(),e._board.holding.right=Date.now(),e._board.holding.left=null,e._board.holding.drop=null},n=function(t){t.preventDefault(),e._board.cur.drop(),e._board.holding.drop=Date.now()},r=function(t){t.preventDefault(),e._board.holding.left=null},s=function(t){t.preventDefault(),e._board.holding.right=null},a=function(t){t.preventDefault(),e._board.holding.drop=null},h=function(t){t.preventDefault(),e._board.cur.rotate("left")},l=function(t){t.preventDefault(),e._board.cur.rotate("right")};e._$touchLeft.unbind("touchstart touchend click"),e._$touchRight.unbind("touchstart touchend click"),e._$touchRotateLeft.unbind("touchstart touchend click"),e._$touchRotateRight.unbind("touchstart touchend click"),e._$touchDrop.unbind("touchstart touchend click"),!e.options.autoplay&&t?(e._$touchLeft.show().bind("touchstart click",o).bind("touchend",r),e._$touchRight.show().bind("touchstart click",i).bind("touchend",s),e._$touchDrop.show().bind("touchstart click",n).bind("touchend",a),e._$touchRotateLeft.show().bind("touchstart click",h),e._$touchRotateRight.show().bind("touchstart click",l)):(e._$touchLeft.hide(),e._$touchRight.hide(),e._$touchRotateLeft.hide(),e._$touchRotateRight.hide(),e._$touchDrop.hide())},init:function(){var t=this;t.theme(),t._create(),t._refreshBlockSizes(),t.updateSizes(),t._setup(),t._info.init(),t._board.init();var e=function(){requestAnimationFrame(e),t._board.render()};e(),t.options.autoplay?(t.autoplay(!0),t._setupTouchControls(!1)):(t._setupControls(!0),t._setupTouchControls(!1))}},t.fn.tetris=function(e){var o={autoplay:!1,autoplayRestart:!0,showFieldOnStart:!0,theme:{background:"#000000",primary:"#eee",secondary:"#eee",stroke:"#eee",strokeWidth:2},blockWidth:10,autoBlockWidth:!1,autoBlockSize:24,difficulty:"normal",speed:20,asdwKeys:!0,playText:"开始玩俄罗斯方块！",playButtonText:"开始",gameOverText:"游戏结束",restartButtonText:"再玩一次",scoreText:"得分",onStart:function(){},onRestart:function(){},onGameOver:function(t){},onPlaced:function(){},onLine:function(t,e,o){}},i=t.extend({},o,e);return this.each(function(e,o){new n(i,t(o)).init()})},t(function(){t("#tetris-demo").css({width:t(e).width(),height:t(e).height()}),r.init({holder:"#tetris-demo",random:!0,paths:"../mp3/",playlist:["m1.mp3","m2.mp3","m3.mp3"]}),r.play()})}(jQuery,window,document),function(t){function e(t,e){this.x=t,this.y=e}function o(t,e){this.p1=t,this.p2=e,this.length=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}function i(){this.points=[],this.lines=[],this.init()}function n(t,e,o){this.points=[t,e,o],this.getArea=function(){var t=this.getPerimeter(),e=t/2;return Math.sqrt(e*(e-this.lines[0].length)*(e-this.lines[1].length)*(e-this.lines[2].length))}}function r(t,o,i){this.points=[t,new e(t.x+o,t.y),new e(t.x+o,t.y+i),new e(t.x,t.y+i)],this.getArea=function(){return i*i}}function s(t,e){r.call(this,t,e,e)}i.prototype={constructor:i,init:function(){var t=document.createElement("canvas");t.id="canvas",t.width="1000",t.height="500",t.style="position: fixed; width: 1000px; height: 500px; left: 0; top: 0;",document.body.appendChild(t),void 0===this.context&&(i.prototype.context=t.getContext("2d"))},draw:function(){var t,e=this.context;for(e.strokeStyle=this.getColor(),e.lineWidth=2,console.log(this.points),e.beginPath(),e.moveTo(this.points[0].x,this.points[0].y),t=1;t<this.points.length;t++)e.lineTo(this.points[t].x,this.points[t].y);e.closePath(),e.stroke()},getColor:function(){var t,e=[];for(t=0;t<3;t++)e[t]=Math.round(255*Math.random());return"rgb("+e.join(", ")+")"},getLines:function(){if(this.lines.length>0)return this.lines;var t,e=[];for(t=0;t<this.points.length;t++)e[t]=new o(this.points[t],this.points[t+1]||this.points[0]);return this.lines=e,e},getArea:function(){},getPerimeter:function(){var t,e=0,o=this.getLines();for(t=0;t<o.length;t++)e+=o[t].length;return e}};var a=new i;n.prototype=a,r.prototype=a,s.prototype=a;var h=new e(100,100),l=new e(300,100),c=new e(200,0),d=new n(h,l,c);d.draw(),console.log(d.getPerimeter()),console.log(d.getArea())}(jQuery);